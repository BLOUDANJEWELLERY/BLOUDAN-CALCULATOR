<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alloy Purity Calculator</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff"/>
  <link rel="apple-touch-icon" href="icon-192.png" />
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      background: #f4f4f4;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .input-block {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }

    input[type="number"], input[readonly] {
      width: 100%;
      padding: 8px;
      font-size: 15px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: right;
    }

    input[readonly] {
      background-color: #eaeaea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ccc;
    }

    th {
      background-color: #eee;
    }

    @media (max-width: 600px) {
      input {
        font-size: 14px;
      }

      th, td {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<h2>Alloy Purity Calculator</h2>

<div class="input-block">
  <label for="target-purity">Target Purity (‰)</label>
  <input type="number" id="target-purity" step="0.1" placeholder="e.g. 916">
</div>

<div class="input-block">
  <label for="available-purity">Available Metal Purity (‰)</label>
  <input type="number" id="available-purity" step="0.1" placeholder="e.g. 995">
</div>

<div class="input-block">
  <label for="weight-needed">Weight to Add (g)</label>
  <input type="text" id="weight-needed" readonly>
</div>

<div class="input-block">
  <label for="copper-needed">Copper Needed (g)</label>
  <input type="text" id="copper-needed" readonly>
</div>

<table>
  <thead>
    <tr>
      <th>Weight (g)</th>
      <th>Purity (‰)</th>
      <th>Net Weight</th>
    </tr>
  </thead>
  <tbody id="table-body">
    <script>
      for (let i = 0; i < 6; i++) {
        document.write(`
          <tr>
            <td><input type="number" step="0.01" class="weight" oninput="calculateAll()"></td>
            <td><input type="number" step="0.1" class="purity" oninput="calculateAll()"></td>
            <td><input type="text" class="net" readonly></td>
          </tr>
        `);
      }
    </script>
  </tbody>
  <tfoot>
    <tr>
      <td><input type="text" id="total-weight" readonly></td>
      <td><input type="text" id="avg-purity" readonly></td>
      <td><input type="text" id="total-net" readonly></td>
    </tr>
  </tfoot>
</table>

<script>
  function calculateAll() {
    const rows = document.querySelectorAll('#table-body tr');
    let totalWeight = 0;
    let totalNet = 0;

    rows.forEach(row => {
      const weight = parseFloat(row.querySelector('.weight').value) || 0;
      const purity = parseFloat(row.querySelector('.purity').value) || 0;
      const net = weight * purity / 999;
      row.querySelector('.net').value = net ? net.toFixed(3) : '';
      totalWeight += weight;
      totalNet += net;
    });

    const avgPurity = totalWeight > 0 ? (totalNet / totalWeight) * 999 : 0;

    document.getElementById('total-weight').value = totalWeight.toFixed(2);
    document.getElementById('total-net').value = totalNet.toFixed(3);
    document.getElementById('avg-purity').value = avgPurity.toFixed(1);

    const targetPurity = parseFloat(document.getElementById('target-purity').value);
    const addedPurity = parseFloat(document.getElementById('available-purity').value);

    // Weight Needed with user-defined metal
    if (
      totalWeight > 0 &&
      avgPurity > 0 &&
      targetPurity &&
      addedPurity &&
      addedPurity !== targetPurity
    ) {
      const weightToAdd = (totalWeight * (targetPurity - avgPurity)) / (addedPurity - targetPurity);
      document.getElementById('weight-needed').value = weightToAdd > 0 ? weightToAdd.toFixed(2) : "0.00";
    } else {
      document.getElementById('weight-needed').value = '';
    }

    // Copper Needed with 0 purity
    if (
      totalWeight > 0 &&
      avgPurity > 0 &&
      targetPurity &&
      targetPurity !== 0 &&
      avgPurity > targetPurity
    ) {
      const copperNeeded = (totalWeight * (avgPurity - targetPurity)) / targetPurity;
      document.getElementById('copper-needed').value = copperNeeded.toFixed(2);
    } else {
      document.getElementById('copper-needed').value = '';
    }
  }

  document.getElementById('target-purity').addEventListener('input', calculateAll);
  document.getElementById('available-purity').addEventListener('input', calculateAll);
</script>

</body>
</html>